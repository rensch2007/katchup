stages:
  - notify_start
  - build
  - deploy
  - notify_end

variables:
  DOCKER_IMAGE: kylesung0520/katchup
  START_TIME: "$(date +%s)"

notify_discord_start:
  stage: notify_start
  script:
    - echo "CI Start Time: $(date)"
    - echo "START_TIME=$(date +%s)" > start_time.txt
    - curl -H "Content-Type: application/json" \
      -X POST \
      -d "{\"content\": \"ğŸš€ *CI/CD ì‹œì‘ë¨:* \`$CI_PROJECT_NAME\` ì˜ \`$CI_COMMIT_REF_NAME\` ë¸Œëœì¹˜ ë°°í¬ íŒŒì´í”„ë¼ì¸ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\"}" $DISCORD_WEBHOOK_URL
  rules:
    - if: '$CI_COMMIT_BRANCH == "KATCHUP-9-set-up-ci-cd"'
  artifacts:
    paths:
      - start_time.txt
    expire_in: 1 hour

build_backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - cd backend
    - docker build -t "$DOCKER_IMAGE:latest" .
    - docker push "$DOCKER_IMAGE:latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == "KATCHUP-9-set-up-ci-cd"'

deploy_to_ec2:
  stage: deploy
  script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/gitlab-ec2-openssh
    - chmod 600 ~/.ssh/gitlab-ec2-openssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H 43.202.220.249 >> ~/.ssh/known_hosts
    - >
      ssh -i ~/.ssh/gitlab-ec2-openssh -o StrictHostKeyChecking=no ec2-user@43.202.220.249 '
        docker pull kylesung0520/katchup:latest &&
        if [ "$(docker ps -a -q -f name=katchup-backend)" ]; then
          docker stop katchup-backend && docker rm katchup-backend;
        fi &&
        sudo docker run -d --name katchup-backend \
          --env-file /home/ec2-user/katchup-backend/.env \
          -p 5001:5001 \
          kylesung0520/katchup:latest
      '
  rules:
    - if: '$CI_COMMIT_BRANCH == "KATCHUP-9-set-up-ci-cd"'

notify_discord:
  stage: notify_end
  script:
    - |
      END_TIME=$(date +%s)
      START_TIME=$(cat start_time.txt)
      DURATION=$((END_TIME - START_TIME))
      MINUTES=$((DURATION / 60))
      SECONDS=$((DURATION % 60))
      STATUS_MSG="âœ… *CI/CD ì„±ê³µ:* \`$CI_PROJECT_NAME\` ì˜ \`$CI_COMMIT_REF_NAME\` ë¸Œëœì¹˜ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nâ± ì†Œìš” ì‹œê°„: ${MINUTES}ë¶„ ${SECONDS}ì´ˆ"
      if [[ "$CI_JOB_STATUS" == "failed" ]]; then
        STATUS_MSG="âŒ *CI/CD ì‹¤íŒ¨:* \`$CI_PROJECT_NAME\` ì˜ \`$CI_COMMIT_REF_NAME\` ë¸Œëœì¹˜ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nâ± ì†Œìš” ì‹œê°„: ${MINUTES}ë¶„ ${SECONDS}ì´ˆ"
      fi
      curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"$STATUS_MSG\"}" $DISCORD_WEBHOOK_URL
  when: always
  only:
    - KATCHUP-9-set-up-ci-cd
  rules:
    - if: '$CI_COMMIT_BRANCH == "KATCHUP-9-set-up-ci-cd"'