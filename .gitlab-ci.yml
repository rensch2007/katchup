stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: kylesung0520/katchup-backend

build_backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - cd backend
    - docker build -t $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:latest

deploy_to_ec2:
  stage: deploy
  script:
    - ssh -o StrictHostKeyChecking=no ec2-user@<YOUR_EC2_PUBLIC_IP> "
        docker pull $DOCKER_IMAGE:latest &&
        docker stop katchup-backend || true &&
        docker rm katchup-backend || true &&
        docker run -d --name katchup-backend \
          --env-file /home/ec2-user/katchup-backend/.env \
          -p 5001:5001 \
          $DOCKER_IMAGE:latest
      "
  only:
    - KATCHUP-9-set-up-ci-cd